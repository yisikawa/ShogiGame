# USIエンジンデバッグガイド

Chrome MCPを使用してUSIエンジンのデバッグを行う方法です。

## デバッグ機能

### 1. 詳細なログ出力

USIクライアントとサーバーは、Chrome DevToolsで見やすい形式でログを出力します。

#### ログレベル

- **情報 (info)**: 青色 (`#2196F3`) - 通常の処理情報
- **成功 (success)**: 緑色 (`#4CAF50`) - 成功した処理
- **警告 (warn)**: オレンジ色 (`#FF9800`) - 警告メッセージ
- **エラー (error)**: 赤色 (`#F44336`) - エラーメッセージ
- **特殊 (special)**: 紫色 (`#9C27B0`) - 重要な処理（最善手取得など）

### 2. パフォーマンス測定

各処理の実行時間が自動的に測定され、ログに表示されます：

- SFEN変換時間
- 局面設定時間
- 思考時間
- 手の変換時間
- 合計時間

### 3. エラーハンドリング

エラーが発生した場合、以下の情報がログに記録されます：

- エラーメッセージ
- スタックトレース
- リクエストの詳細（URL、パラメータなど）
- 実行時間

## Chrome DevToolsでの確認方法

### 1. コンソールを開く

1. ブラウザで将棋ゲームを開く
2. `F12` または `Ctrl+Shift+I` (Windows) / `Cmd+Option+I` (Mac) でDevToolsを開く
3. 「Console」タブを選択

### 2. ログの確認

#### 接続時

```
[USI] サーバー接続開始
[USI] サーバー接続成功
[USI] エンジン初期化
[USI] エンジン初期化完了
```

#### 最善手取得時

```
[USI] 最善手取得
  ├─ SFEN変換完了
  ├─ 局面設定リクエスト送信
  ├─ 局面設定成功
  ├─ 思考開始リクエスト送信
  ├─ 思考完了
  └─ 手の変換完了
```

#### エラー時

```
[USI] エラー: ...
  ├─ エラーメッセージ
  ├─ スタックトレース
  └─ 実行時間
```

### 3. ネットワークタブでの確認

1. DevToolsの「Network」タブを開く
2. 「Filter」で「usi」と入力してUSI関連のリクエストをフィルタリング
3. 各リクエストをクリックして詳細を確認：
   - リクエストヘッダー
   - リクエストボディ
   - レスポンスヘッダー
   - レスポンスボディ
   - タイミング情報

### 4. サーバー側のログ確認

Node.jsサーバーを起動しているターミナルでも、同様のログが表示されます：

```bash
[USI Server] 接続リクエスト受信
[USI Server] → エンジン: usi
[USI Server] ← エンジン: id name ...
[USI Server] ← エンジン: usiok
[USI Server] エンジン準備完了
```

## デバッグのポイント

### 1. 接続エラー

**症状**: サーバーに接続できない

**確認項目**:
- サーバーが起動しているか（`http://localhost:8080/health` にアクセス）
- サーバーURLが正しいか
- CORSエラーが発生していないか（Networkタブで確認）

**ログ例**:
```
[USI] サーバー接続開始 { serverUrl: "http://localhost:8080" }
[USI] 接続エラー: 500 { status: 500, statusText: "Internal Server Error" }
```

### 2. エンジン初期化エラー

**症状**: エンジンが初期化できない

**確認項目**:
- エンジンが起動しているか（サーバーログを確認）
- エンジンがUSIプロトコルに対応しているか
- タイムアウトが発生していないか

**ログ例**:
```
[USI] エンジン初期化
[USI] USI初期化コマンド送信
[USI] 初期化エラー: 500 { error: "エンジンの初期化がタイムアウトしました" }
```

### 3. 思考タイムアウト

**症状**: 思考が完了しない

**確認項目**:
- エンジンが正常に動作しているか
- タイムアウト時間が適切か（デフォルト: 5000ms）
- エンジンがクラッシュしていないか

**ログ例**:
```
[USI] 思考開始リクエスト送信 { timeLimit: 5000 }
[USI] goエラー: 500 { error: "思考がタイムアウトしました" }
```

### 4. 手の変換エラー

**症状**: エンジンが返した手が無効

**確認項目**:
- USI形式の手が正しいか
- 座標変換が正しいか
- エンジンが返した手の形式を確認

**ログ例**:
```
[USI] 思考完了 { bestmove: "7g7f" }
[USI] 手の変換完了 { usiMove: "7g7f", parsedMove: {...} }
```

## デバッグモードの有効/無効

デバッグログを無効にする場合は、`usi.js`の`debugMode`を`false`に設定：

```javascript
this.debugMode = false; // デバッグログを無効化
```

## パフォーマンス最適化

ログに表示される実行時間を確認して、ボトルネックを特定：

- **SFEN変換**: 通常 < 1ms
- **局面設定**: 通常 < 10ms
- **思考時間**: エンジンに依存（通常 1-5秒）
- **手の変換**: 通常 < 1ms

思考時間が長すぎる場合は、`timeLimit`パラメータを調整してください。

## トラブルシューティング

### 問題: ログが表示されない

**解決策**:
1. ブラウザのコンソールが開いているか確認
2. コンソールのフィルタで「All levels」が選択されているか確認
3. `debugMode`が`true`に設定されているか確認

### 問題: エラーメッセージが不明確

**解決策**:
1. エラーログのスタックトレースを確認
2. Networkタブでリクエスト/レスポンスの詳細を確認
3. サーバー側のログも確認

### 問題: パフォーマンスが悪い

**解決策**:
1. ログの実行時間を確認してボトルネックを特定
2. 思考時間を調整（`timeLimit`パラメータ）
3. エンジンの設定を確認

## 参考

- [Chrome DevTools ドキュメント](https://developer.chrome.com/docs/devtools/)
- [USIプロトコル仕様](http://www.geocities.jp/shogidokoro/usi/usi_protocol.html)

